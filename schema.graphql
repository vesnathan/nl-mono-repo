schema {
  query: Query
  mutation: Mutation
  subscription: Subscription
}

#  Bookmark Type and Operations
type Bookmark @aws_cognito_user_pools {
  breadcrumbs: [String!]!
  currentNodeId: ID!
  lastRead: String!
  storyId: ID!
  userId: ID!
}

type ChapterBadges {
  authorApproved: Boolean!
  matchesVision: Boolean!
}

type ChapterNode @aws_cognito_user_pools {
  authorId: String!
  badges: ChapterBadges!
  branchDescription: String
  chapterNumber: Int!
  content: String!
  createdAt: String!
  editableUntil: String!
  nodeId: ID!
  paragraphIndex: Int
  parentNodeId: ID
  stats: ChapterStats!
  storyId: ID!
}

#  Base Schema - Defines root Query, Mutation, and Subscription types
# Chapter/Branch Type Definitions
type ChapterStats {
  childBranches: Int!
  downvotes: Int!
  reads: Int!
  upvotes: Int!
}

type Mutation {
  awardBadge(input: AwardBadgeInput!): ChapterNode @aws_cognito_user_pools
  createBranch(input: CreateBranchInput!): ChapterNode @aws_cognito_user_pools
  createChapter(input: CreateChapterInput!): ChapterNode @aws_cognito_user_pools
  createNotification(input: CreateNotificationInput!): Notification @aws_cognito_user_pools
  createStory(input: CreateStoryInput!): Story @aws_cognito_user_pools
  markAllNotificationsAsRead(userId: ID!): Boolean! @aws_cognito_user_pools
  markNotificationAsRead(notificationId: ID!): Notification @aws_cognito_user_pools
  saveBookmark(input: SaveBookmarkInput!): Bookmark @aws_cognito_user_pools
  updateChapter(input: UpdateChapterInput!): ChapterNode @aws_cognito_user_pools
  updateStory(input: UpdateStoryInput!): Story @aws_cognito_user_pools
  voteOnChapter(nodeId: ID!, storyId: ID!, voteType: VoteType!): ChapterNode @aws_cognito_user_pools
}

#  Real-time Subscriptions
# Notification Types
type Notification @aws_cognito_user_pools {
  createdAt: String!
  message: String!
  notificationId: ID!
  read: Boolean!
  relatedNodeId: ID
  relatedStoryId: ID
  relatedUserId: ID
  type: NotificationType!
  userId: ID!
}

#  Notification Queries and Mutations
type NotificationConnection {
  items: [Notification!]!
  nextToken: String
}

#  User Queries and Mutations
type Query {
  getBookmark(storyId: ID!): Bookmark @aws_cognito_user_pools
  getChapter(nodeId: ID!, storyId: ID!): ChapterNode @aws_cognito_user_pools
  getReadingPath(nodePath: [ID!]!, storyId: ID!): [ChapterNode!]! @aws_cognito_user_pools
  getStory(storyId: ID!): Story @aws_cognito_user_pools
  getStoryTree(storyId: ID!): TreeData @aws_cognito_user_pools
  getUnreadCount(userId: ID!): Int! @aws_cognito_user_pools
  getUserNotifications(limit: Int, nextToken: String, userId: ID!): NotificationConnection @aws_cognito_user_pools
  getUserProfile(userId: ID!): User @aws_cognito_user_pools
  listBranches(nodeId: ID!, storyId: ID!): [ChapterNode!]! @aws_cognito_user_pools
  listStories(filter: StoryFilter, limit: Int, nextToken: String): StoryConnection @aws_cognito_user_pools
}

type Story @aws_cognito_user_pools {
  ageRating: AgeRating!
  authorId: String!
  contentWarnings: [String!]!
  coverImageUrl: String
  createdAt: String!
  featured: Boolean!
  genre: [String!]!
  ratingExplanation: String
  stats: StoryStats!
  storyId: ID!
  synopsis: String!
  title: String!
}

type StoryConnection {
  items: [Story!]!
  nextToken: String
}

type StoryStats {
  rating: Float
  totalBranches: Int!
  totalReads: Int!
}

type Subscription {
  onNewBranch(storyId: ID!): ChapterNode @aws_subscribe(mutations : ["createBranch"])
  onNewNotification(userId: ID!): Notification @aws_subscribe(mutations : ["createNotification"])
}

#  Chapter/Branch Queries and Mutations
# Story Queries and Mutations
# Tree visualization data structure
type TreeData {
  rootNode: TreeNode!
  totalNodes: Int!
}

type TreeNode {
  authorId: String!
  badges: ChapterBadges!
  children: [TreeNode!]!
  description: String
  nodeId: ID!
  stats: ChapterStats!
  title: String!
}

type User @aws_cognito_user_pools {
  bio: String
  clientType: [ClientType!]!
  createdAt: String!
  email: String!
  patreonSupporter: Boolean!
  stats: UserStats!
  userId: ID!
  username: String!
}

type UserStats {
  branchesContributed: Int!
  storiesCreated: Int!
  totalUpvotes: Int!
}

#  Story Type Definitions
enum AgeRating {
  ADULT_18_PLUS
  G
  M
  T
}

enum BadgeType {
  AUTHOR_APPROVED
  MATCHES_VISION
}

#  User Type Definitions
enum ClientType {
  Reader
  SiteAdmin
  StoryContributor
  UnauthenticatedUser
}

enum NotificationType {
  AUTHOR_RESPONSE
  BADGE_AWARDED
  NEW_BRANCH
  VOTE_RECEIVED
}

enum VoteType {
  DOWN
  UP
}

input AwardBadgeInput {
  badgeType: BadgeType!
  nodeId: ID!
  storyId: ID!
}

input CreateBranchInput {
  branchDescription: String!
  content: String!
  paragraphIndex: Int
  parentNodeId: ID!
  ratingFlag: Boolean
}

input CreateChapterInput {
  chapterNumber: Int!
  content: String!
  storyId: ID!
}

input CreateNotificationInput {
  message: String!
  relatedNodeId: ID
  relatedStoryId: ID
  relatedUserId: ID
  type: NotificationType!
  userId: ID!
}

input CreateStoryInput {
  ageRating: AgeRating!
  contentWarnings: [String!]!
  coverImageUrl: String
  genre: [String!]!
  ratingExplanation: String
  synopsis: String!
  title: String!
}

input SaveBookmarkInput {
  breadcrumbs: [String!]!
  currentNodeId: ID!
  storyId: ID!
}

input StoryFilter {
  ageRating: AgeRating
  featured: Boolean
  genre: String
  minRating: Float
}

input UpdateChapterInput {
  branchDescription: String
  content: String
  nodeId: ID!
  storyId: ID!
}

input UpdateStoryInput {
  ageRating: AgeRating
  contentWarnings: [String!]
  coverImageUrl: String
  featured: Boolean
  genre: [String!]
  storyId: ID!
  synopsis: String
  title: String
}
