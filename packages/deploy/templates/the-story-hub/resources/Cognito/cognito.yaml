AWSTemplateFormatVersion: "2010-09-09"
Description: "The Story Hub Cognito User Pool Resources"

Parameters:
  Stage:
    Type: String
    Description: Deployment stage (e.g., dev, prod)
  AppName:
    Type: String
    Description: Application short name used in exported resource names
  TemplateBucketName:
    Type: String
    Description: S3 bucket name for CloudFormation templates
  DataTableName:
    Type: String
    Description: DynamoDB table name for application data
  LogRetentionInDays:
    Type: Number
    Description: Number of days to retain CloudWatch Logs
    Default: 14

Resources:
  # Secrets Manager for Google OAuth credentials
  # Created here (not in LambdaStack) to avoid circular dependency
  GoogleOAuthSecrets:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub "nlmonorepo-${AppName}-google-oauth-secrets-${Stage}"
      Description: Google OAuth credentials for Sign-In integration
      SecretString: |
        {
          "clientId": "PLACEHOLDER_CLIENT_ID",
          "clientSecret": "PLACEHOLDER_CLIENT_SECRET"
        }

  UserPool:
    Type: AWS::Cognito::UserPool
    Properties:
      UserPoolName: !Sub "nlmonorepo-tsh-userpool-${Stage}"
      Schema:
        - Name: email
          AttributeDataType: String
          Mutable: true
          Required: true
      Policies:
        PasswordPolicy:
          MinimumLength: 8
      MfaConfiguration: "OFF"
      LambdaConfig:
        PostConfirmation: !GetAtt CognitoPostConfirmationFunction.Arn
      UserPoolTags:
        Stack: !Sub "nlmonorepo-tsh-${Stage}"

  # Cognito User Pool Domain (required for OAuth)
  UserPoolDomain:
    Type: AWS::Cognito::UserPoolDomain
    Properties:
      Domain: !Sub "nlmonorepo-tsh-${Stage}"
      UserPoolId: !Ref UserPool

  # Google Identity Provider
  GoogleIdentityProvider:
    Type: AWS::Cognito::UserPoolIdentityProvider
    Properties:
      UserPoolId: !Ref UserPool
      ProviderName: Google
      ProviderType: Google
      ProviderDetails:
        client_id: !Sub "{{resolve:secretsmanager:nlmonorepo-${AppName}-google-oauth-secrets-${Stage}:SecretString:clientId}}"
        client_secret: !Sub "{{resolve:secretsmanager:nlmonorepo-${AppName}-google-oauth-secrets-${Stage}:SecretString:clientSecret}}"
        authorize_scopes: "email openid profile"
      AttributeMapping:
        email: email
        name: name
        picture: picture
        username: sub

  UserPoolClient:
    Type: AWS::Cognito::UserPoolClient
    DependsOn: GoogleIdentityProvider
    Properties:
      ClientName: !Sub "nlmonorepo-tsh-client-${Stage}"
      UserPoolId: !Ref UserPool
      GenerateSecret: false
      SupportedIdentityProviders:
        - COGNITO
        - Google
      CallbackURLs:
        - "https://d2d51g7zjzznag.cloudfront.net"
        - "http://localhost:3000"
      LogoutURLs:
        - "https://d2d51g7zjzznag.cloudfront.net"
        - "http://localhost:3000"
      AllowedOAuthFlows:
        - code
        - implicit
      AllowedOAuthScopes:
        - email
        - openid
        - profile
        - aws.cognito.signin.user.admin
      AllowedOAuthFlowsUserPoolClient: true

  IdentityPool:
    Type: AWS::Cognito::IdentityPool
    Properties:
      IdentityPoolName: !Sub "nlmonorepo_awse_identity_pool_${Stage}"
      AllowUnauthenticatedIdentities: true
      CognitoIdentityProviders:
        - ClientId: !Ref UserPoolClient
          ProviderName: !GetAtt UserPool.ProviderName

  IdentityPoolRoleAttachment:
    Type: AWS::Cognito::IdentityPoolRoleAttachment
    Properties:
      IdentityPoolId: !Ref IdentityPool
      Roles:
        authenticated: !GetAtt AuthenticatedRole.Arn
        unauthenticated: !GetAtt UnauthenticatedRole.Arn

  # Post-Confirmation Lambda Function
  CognitoPostConfirmationFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "nlmonorepo-thestoryhub-cognito-post-confirmation-${Stage}"
      Runtime: nodejs20.x
      Handler: index.handler
      Role: !GetAtt CognitoPostConfirmationRole.Arn
      Timeout: 30
      Environment:
        Variables:
          TABLE_NAME: !Ref DataTableName
      Code:
        S3Bucket: !Ref TemplateBucketName
        S3Key: !Sub "functions/${Stage}/cognitoPostConfirmation.zip"

  CognitoPostConfirmationRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "nlmonorepo-thestoryhub-cognito-post-confirmation-role-${Stage}"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: DynamoDBAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:PutItem
                Resource: !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${DataTableName}"

  CognitoPostConfirmationPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref CognitoPostConfirmationFunction
      Principal: cognito-idp.amazonaws.com
      Action: lambda:InvokeFunction
      SourceArn: !GetAtt UserPool.Arn

  CognitoPostConfirmationFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/nlmonorepo-thestoryhub-cognito-post-confirmation-${Stage}"
      RetentionInDays: !Ref LogRetentionInDays

  AuthenticatedRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "nlmonorepo-tsh-authenticated-role-${Stage}"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Federated: cognito-identity.amazonaws.com
            Action: sts:AssumeRoleWithWebIdentity
            Condition:
              StringEquals:
                cognito-identity.amazonaws.com:aud: !Ref IdentityPool
              ForAnyValue:StringLike:
                cognito-identity.amazonaws.com:amr: authenticated
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AWSAppSyncInvokeFullAccess

  UnauthenticatedRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "nlmonorepo-tsh-unauthenticated-role-${Stage}"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Federated: cognito-identity.amazonaws.com
            Action: sts:AssumeRoleWithWebIdentity
            Condition:
              StringEquals:
                cognito-identity.amazonaws.com:aud: !Ref IdentityPool
              ForAnyValue:StringLike:
                cognito-identity.amazonaws.com:amr: unauthenticated
      Policies:
        - PolicyName: UnauthenticatedReadOnlyPolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - appsync:GraphQL
                Resource:
                  # Allow only read queries (get*, list*)
                  - !Sub "arn:aws:appsync:${AWS::Region}:${AWS::AccountId}:apis/*/types/Query/fields/getStory"
                  - !Sub "arn:aws:appsync:${AWS::Region}:${AWS::AccountId}:apis/*/types/Query/fields/listStories"
                  - !Sub "arn:aws:appsync:${AWS::Region}:${AWS::AccountId}:apis/*/types/Query/fields/getChapter"
                  - !Sub "arn:aws:appsync:${AWS::Region}:${AWS::AccountId}:apis/*/types/Query/fields/listBranches"
                  - !Sub "arn:aws:appsync:${AWS::Region}:${AWS::AccountId}:apis/*/types/Query/fields/getStoryTree"
                  - !Sub "arn:aws:appsync:${AWS::Region}:${AWS::AccountId}:apis/*/types/Query/fields/getReadingPath"
                  - !Sub "arn:aws:appsync:${AWS::Region}:${AWS::AccountId}:apis/*/types/Query/fields/getUserProfile"
                  # Comment read queries
                  - !Sub "arn:aws:appsync:${AWS::Region}:${AWS::AccountId}:apis/*/types/Query/fields/listComments"
                  - !Sub "arn:aws:appsync:${AWS::Region}:${AWS::AccountId}:apis/*/types/Query/fields/getComment"
                  - !Sub "arn:aws:appsync:${AWS::Region}:${AWS::AccountId}:apis/*/types/Query/fields/listReplies"

Outputs:
  UserPoolId:
    Description: ID of the Cognito User Pool
    Value: !Ref UserPool
    # Export removed: top-level template will declare global export

  UserPoolArn:
    Description: ARN of the Cognito User Pool
    Value: !GetAtt UserPool.Arn

  UserPoolClientId:
    Description: ID of the Cognito User Pool Client
    Value: !Ref UserPoolClient
    # Export removed: top-level template will declare global export

  UserPoolProviderName:
    Description: Provider name of the Cognito User Pool
    Value: !GetAtt UserPool.ProviderName
    # Export removed: top-level template will declare canonical exports

  IdentityPoolId:
    Description: ID of the Cognito Identity Pool
    Value: !Ref IdentityPool
    # Export removed: top-level template will declare global export

  UserPoolDomain:
    Description: Cognito User Pool Domain (for OAuth redirects)
    Value: !Sub "https://${UserPoolDomain}.auth.${AWS::Region}.amazoncognito.com"

  UserPoolDomainName:
    Description: Cognito User Pool Domain Name (without https://)
    Value: !Sub "${UserPoolDomain}.auth.${AWS::Region}.amazoncognito.com"

  GoogleOAuthSecretsArn:
    Description: ARN of the Google OAuth Secrets in Secrets Manager
    Value: !Ref GoogleOAuthSecrets
