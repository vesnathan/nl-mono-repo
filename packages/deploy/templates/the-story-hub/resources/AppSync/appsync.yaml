AWSTemplateFormatVersion: "2010-09-09"
Description: "AppSync Resources for the application"

Parameters:
  Stage:
    Type: String
    Description: Deployment stage (e.g., dev, prod)
    AllowedPattern: ^[a-zA-Z0-9-]+$
  AppName:
    Type: String
    Description: Application Name (e.g., tsh, wbc)
  DataTableName:
    Type: String
    Description: DynamoDB table name for application data (passed from parent stack)
  AppSyncDynamoDBRoleArn:
    Type: String
    Description: ARN of the IAM role AppSync should use to access DynamoDB (passed from parent)
  TemplateBucketName:
    Type: String
    Description: S3 bucket containing templates and resolvers
  ResolversBuildHash:
    Type: String
    Description: Optional build hash used to version resolver S3 keys (set by deploy script)
  SchemaHash:
    Type: String
    Description: Content hash of GraphQL schema for versioning
  LogRetentionInDays:
    Type: Number
    Description: Number of days to retain CloudWatch Logs for AppSync and Lambda
    Default: 14
  UserPoolId:
    Type: String
    Description: Cognito User Pool ID

Resources:
  AppSyncLoggingServiceRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "${AppName}-appsync-logging-role-${Stage}"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: appsync.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: !Sub "${AppName}-appsync-logging-policy-${Stage}"
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: "*"

  GraphQlApi:
    Type: AWS::AppSync::GraphQLApi
    Properties:
      Name: !Sub "${AppName}-appsync-api-${Stage}"
      AuthenticationType: AMAZON_COGNITO_USER_POOLS
      UserPoolConfig:
        UserPoolId: !Ref UserPoolId
        DefaultAction: ALLOW
        AwsRegion: ap-southeast-2
      AdditionalAuthenticationProviders:
        - AuthenticationType: AWS_IAM
      LogConfig:
        CloudWatchLogsRoleArn: !GetAtt AppSyncLoggingServiceRole.Arn
        FieldLogLevel: ALL
        ExcludeVerboseContent: false

  GraphQlSchema:
    Type: AWS::AppSync::GraphQLSchema
    Properties:
      ApiId: !GetAtt GraphQlApi.ApiId
      DefinitionS3Location: !Sub "s3://${TemplateBucketName}/schema-${SchemaHash}.graphql"

  MainTableDataSource: # Renamed from UsersTableDataSource for generality
    Type: AWS::AppSync::DataSource
    Properties:
      ApiId: !GetAtt GraphQlApi.ApiId
      Name: !Sub "${AppName}MainTableDynamoDBDataSource" # Parameterized name
      Type: AMAZON_DYNAMODB
      DynamoDBConfig:
        TableName: !Ref DataTableName
        AwsRegion: !Ref AWS::Region
      ServiceRoleArn: !Ref AppSyncDynamoDBRoleArn

  NoneDataSource:
    Type: AWS::AppSync::DataSource
    Properties:
      ApiId: !GetAtt GraphQlApi.ApiId
      Name: !Sub "${AppName}NoneDataSource"
      Type: NONE

  # User Resolvers
  GetUserProfileResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt GraphQlApi.ApiId
      TypeName: Query
      FieldName: getUserProfile
      DataSourceName: !GetAtt MainTableDataSource.Name
      Kind: UNIT
      Runtime:
        Name: APPSYNC_JS
        RuntimeVersion: 1.0.0
      CodeS3Location: !Sub "s3://${TemplateBucketName}/resolvers/${Stage}/${ResolversBuildHash}/users/Queries/Query.getUserProfile.js"

  CheckUsernameAvailabilityResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt GraphQlApi.ApiId
      TypeName: Query
      FieldName: checkUsernameAvailability
      DataSourceName: !GetAtt MainTableDataSource.Name
      Kind: UNIT
      Runtime:
        Name: APPSYNC_JS
        RuntimeVersion: 1.0.0
      CodeS3Location: !Sub "s3://${TemplateBucketName}/resolvers/${Stage}/${ResolversBuildHash}/users/Queries/Query.checkUsernameAvailability.js"

  # Story Resolvers
  GetStoryResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt GraphQlApi.ApiId
      TypeName: Query
      FieldName: getStory
      DataSourceName: !GetAtt MainTableDataSource.Name
      Kind: UNIT
      Runtime:
        Name: APPSYNC_JS
        RuntimeVersion: 1.0.0
      CodeS3Location: !Sub "s3://${TemplateBucketName}/resolvers/${Stage}/${ResolversBuildHash}/stories/Queries/Query.getStory.js"

  ListStoriesResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt GraphQlApi.ApiId
      TypeName: Query
      FieldName: listStories
      Kind: PIPELINE
      PipelineConfig:
        Functions:
          - !GetAtt QueryStoriesFunction.FunctionId
      Runtime:
        Name: APPSYNC_JS
        RuntimeVersion: 1.0.0
      CodeS3Location: !Sub "s3://${TemplateBucketName}/resolvers/${Stage}/${ResolversBuildHash}/stories/Queries/Query.listStories.pipeline.js"

  GetStoryTreeResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt GraphQlApi.ApiId
      TypeName: Query
      FieldName: getStoryTree
      DataSourceName: !GetAtt MainTableDataSource.Name
      Kind: UNIT
      Runtime:
        Name: APPSYNC_JS
        RuntimeVersion: 1.0.0
      CodeS3Location: !Sub "s3://${TemplateBucketName}/resolvers/${Stage}/${ResolversBuildHash}/stories/Queries/Query.getStoryTree.js"

  GetReadingPathResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt GraphQlApi.ApiId
      TypeName: Query
      FieldName: getReadingPath
      DataSourceName: !GetAtt MainTableDataSource.Name
      Kind: UNIT
      Runtime:
        Name: APPSYNC_JS
        RuntimeVersion: 1.0.0
      CodeS3Location: !Sub "s3://${TemplateBucketName}/resolvers/${Stage}/${ResolversBuildHash}/stories/Queries/Query.getReadingPath.js"

  CreateStoryResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt GraphQlApi.ApiId
      TypeName: Mutation
      FieldName: createStory
      DataSourceName: !GetAtt MainTableDataSource.Name
      Kind: UNIT
      Runtime:
        Name: APPSYNC_JS
        RuntimeVersion: 1.0.0
      CodeS3Location: !Sub "s3://${TemplateBucketName}/resolvers/${Stage}/${ResolversBuildHash}/stories/Mutations/Mutation.createStory.js"

  UpdateStoryResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt GraphQlApi.ApiId
      TypeName: Mutation
      FieldName: updateStory
      DataSourceName: !GetAtt MainTableDataSource.Name
      Kind: UNIT
      Runtime:
        Name: APPSYNC_JS
        RuntimeVersion: 1.0.0
      CodeS3Location: !Sub "s3://${TemplateBucketName}/resolvers/${Stage}/${ResolversBuildHash}/stories/Mutations/Mutation.updateStory.js"

  # Chapter Resolvers
  GetChapterResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt GraphQlApi.ApiId
      TypeName: Query
      FieldName: getChapter
      DataSourceName: !GetAtt MainTableDataSource.Name
      Kind: UNIT
      Runtime:
        Name: APPSYNC_JS
        RuntimeVersion: 1.0.0
      CodeS3Location: !Sub "s3://${TemplateBucketName}/resolvers/${Stage}/${ResolversBuildHash}/chapters/Queries/Query.getChapter.js"

  ListBranchesResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt GraphQlApi.ApiId
      TypeName: Query
      FieldName: listBranches
      DataSourceName: !GetAtt MainTableDataSource.Name
      Kind: UNIT
      Runtime:
        Name: APPSYNC_JS
        RuntimeVersion: 1.0.0
      CodeS3Location: !Sub "s3://${TemplateBucketName}/resolvers/${Stage}/${ResolversBuildHash}/chapters/Queries/Query.listBranches.js"

  CreateChapterResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt GraphQlApi.ApiId
      TypeName: Mutation
      FieldName: createChapter
      Kind: PIPELINE
      PipelineConfig:
        Functions:
          - !GetAtt CreateChapterItemFunction.FunctionId
          - !GetAtt UpdateStoryRootNodeFunction.FunctionId
      Runtime:
        Name: APPSYNC_JS
        RuntimeVersion: 1.0.0
      CodeS3Location: !Sub "s3://${TemplateBucketName}/resolvers/${Stage}/${ResolversBuildHash}/chapters/Mutations/Mutation.createChapter.pipeline.js"

  UpdateChapterResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt GraphQlApi.ApiId
      TypeName: Mutation
      FieldName: updateChapter
      DataSourceName: !GetAtt MainTableDataSource.Name
      Kind: UNIT
      Runtime:
        Name: APPSYNC_JS
        RuntimeVersion: 1.0.0
      CodeS3Location: !Sub "s3://${TemplateBucketName}/resolvers/${Stage}/${ResolversBuildHash}/chapters/Mutations/Mutation.updateChapter.js"

  AwardBadgeResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt GraphQlApi.ApiId
      TypeName: Mutation
      FieldName: awardBadge
      DataSourceName: !GetAtt MainTableDataSource.Name
      Kind: UNIT
      Runtime:
        Name: APPSYNC_JS
        RuntimeVersion: 1.0.0
      CodeS3Location: !Sub "s3://${TemplateBucketName}/resolvers/${Stage}/${ResolversBuildHash}/chapters/Mutations/Mutation.awardBadge.js"

  # Bookmark Resolvers
  GetBookmarkResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt GraphQlApi.ApiId
      TypeName: Query
      FieldName: getBookmark
      DataSourceName: !GetAtt MainTableDataSource.Name
      Kind: UNIT
      Runtime:
        Name: APPSYNC_JS
        RuntimeVersion: 1.0.0
      CodeS3Location: !Sub "s3://${TemplateBucketName}/resolvers/${Stage}/${ResolversBuildHash}/bookmarks/Queries/Query.getBookmark.js"

  SaveBookmarkResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt GraphQlApi.ApiId
      TypeName: Mutation
      FieldName: saveBookmark
      DataSourceName: !GetAtt MainTableDataSource.Name
      Kind: UNIT
      Runtime:
        Name: APPSYNC_JS
        RuntimeVersion: 1.0.0
      CodeS3Location: !Sub "s3://${TemplateBucketName}/resolvers/${Stage}/${ResolversBuildHash}/bookmarks/Mutations/Mutation.saveBookmark.js"

  # Notification Resolvers
  GetUserNotificationsResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt GraphQlApi.ApiId
      TypeName: Query
      FieldName: getUserNotifications
      DataSourceName: !GetAtt MainTableDataSource.Name
      Kind: UNIT
      Runtime:
        Name: APPSYNC_JS
        RuntimeVersion: 1.0.0
      CodeS3Location: !Sub "s3://${TemplateBucketName}/resolvers/${Stage}/${ResolversBuildHash}/notifications/Queries/Query.getUserNotifications.js"

  GetUnreadCountResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt GraphQlApi.ApiId
      TypeName: Query
      FieldName: getUnreadCount
      DataSourceName: !GetAtt MainTableDataSource.Name
      Kind: UNIT
      Runtime:
        Name: APPSYNC_JS
        RuntimeVersion: 1.0.0
      CodeS3Location: !Sub "s3://${TemplateBucketName}/resolvers/${Stage}/${ResolversBuildHash}/notifications/Queries/Query.getUnreadCount.js"

  CreateNotificationResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt GraphQlApi.ApiId
      TypeName: Mutation
      FieldName: createNotification
      DataSourceName: !GetAtt MainTableDataSource.Name
      Kind: UNIT
      Runtime:
        Name: APPSYNC_JS
        RuntimeVersion: 1.0.0
      CodeS3Location: !Sub "s3://${TemplateBucketName}/resolvers/${Stage}/${ResolversBuildHash}/notifications/Mutations/Mutation.createNotification.js"

  MarkNotificationAsReadResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt GraphQlApi.ApiId
      TypeName: Mutation
      FieldName: markNotificationAsRead
      DataSourceName: !GetAtt MainTableDataSource.Name
      Kind: UNIT
      Runtime:
        Name: APPSYNC_JS
        RuntimeVersion: 1.0.0
      CodeS3Location: !Sub "s3://${TemplateBucketName}/resolvers/${Stage}/${ResolversBuildHash}/notifications/Mutations/Mutation.markNotificationAsRead.js"

  MarkAllNotificationsAsReadResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt GraphQlApi.ApiId
      TypeName: Mutation
      FieldName: markAllNotificationsAsRead
      DataSourceName: !GetAtt MainTableDataSource.Name
      Kind: UNIT
      Runtime:
        Name: APPSYNC_JS
        RuntimeVersion: 1.0.0
      CodeS3Location: !Sub "s3://${TemplateBucketName}/resolvers/${Stage}/${ResolversBuildHash}/notifications/Mutations/Mutation.markAllNotificationsAsRead.js"

  # Comment Resolvers
  ListCommentsResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt GraphQlApi.ApiId
      TypeName: Query
      FieldName: listComments
      DataSourceName: !GetAtt MainTableDataSource.Name
      Kind: UNIT
      Runtime:
        Name: APPSYNC_JS
        RuntimeVersion: 1.0.0
      CodeS3Location: !Sub "s3://${TemplateBucketName}/resolvers/${Stage}/${ResolversBuildHash}/comments/Queries/Query.listComments.js"

  ListRepliesResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt GraphQlApi.ApiId
      TypeName: Query
      FieldName: listReplies
      DataSourceName: !GetAtt MainTableDataSource.Name
      Kind: UNIT
      Runtime:
        Name: APPSYNC_JS
        RuntimeVersion: 1.0.0
      CodeS3Location: !Sub "s3://${TemplateBucketName}/resolvers/${Stage}/${ResolversBuildHash}/comments/Queries/Query.listReplies.js"

  # Create Comment Pipeline Functions
  FetchParentCommentFunction:
    Type: AWS::AppSync::FunctionConfiguration
    Properties:
      ApiId: !GetAtt GraphQlApi.ApiId
      Name: !Sub "${AppName}FetchParentCommentFunction"
      DataSourceName: !GetAtt MainTableDataSource.Name
      Runtime:
        Name: APPSYNC_JS
        RuntimeVersion: 1.0.0
      CodeS3Location: !Sub "s3://${TemplateBucketName}/resolvers/${Stage}/${ResolversBuildHash}/comments/Functions/Function.fetchParent.js"

  CreateCommentItemFunction:
    Type: AWS::AppSync::FunctionConfiguration
    Properties:
      ApiId: !GetAtt GraphQlApi.ApiId
      Name: !Sub "${AppName}CreateCommentItemFunction"
      DataSourceName: !GetAtt MainTableDataSource.Name
      Runtime:
        Name: APPSYNC_JS
        RuntimeVersion: 1.0.0
      CodeS3Location: !Sub "s3://${TemplateBucketName}/resolvers/${Stage}/${ResolversBuildHash}/comments/Functions/Function.createComment.js"

  UpdateParentCommentStatsFunction:
    Type: AWS::AppSync::FunctionConfiguration
    Properties:
      ApiId: !GetAtt GraphQlApi.ApiId
      Name: !Sub "${AppName}UpdateParentCommentStatsFunction"
      DataSourceName: !GetAtt MainTableDataSource.Name
      Runtime:
        Name: APPSYNC_JS
        RuntimeVersion: 1.0.0
      CodeS3Location: !Sub "s3://${TemplateBucketName}/resolvers/${Stage}/${ResolversBuildHash}/comments/Functions/Function.updateParentStats.js"

  IncrementStoryCommentsFunction:
    Type: AWS::AppSync::FunctionConfiguration
    Properties:
      ApiId: !GetAtt GraphQlApi.ApiId
      Name: !Sub "${AppName}IncrementStoryCommentsFunction"
      DataSourceName: !GetAtt MainTableDataSource.Name
      Runtime:
        Name: APPSYNC_JS
        RuntimeVersion: 1.0.0
      CodeS3Location: !Sub "s3://${TemplateBucketName}/resolvers/${Stage}/${ResolversBuildHash}/comments/Functions/Function.incrementStoryComments.js"

  CreateCommentResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt GraphQlApi.ApiId
      TypeName: Mutation
      FieldName: createComment
      Kind: PIPELINE
      PipelineConfig:
        Functions:
          - !GetAtt FetchParentCommentFunction.FunctionId
          - !GetAtt CreateCommentItemFunction.FunctionId
          - !GetAtt UpdateParentCommentStatsFunction.FunctionId
          - !GetAtt IncrementStoryCommentsFunction.FunctionId
      Runtime:
        Name: APPSYNC_JS
        RuntimeVersion: 1.0.0
      CodeS3Location: !Sub "s3://${TemplateBucketName}/resolvers/${Stage}/${ResolversBuildHash}/comments/Mutations/Mutation.createComment.pipeline.js"

  UpdateCommentResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt GraphQlApi.ApiId
      TypeName: Mutation
      FieldName: updateComment
      DataSourceName: !GetAtt MainTableDataSource.Name
      Kind: UNIT
      Runtime:
        Name: APPSYNC_JS
        RuntimeVersion: 1.0.0
      CodeS3Location: !Sub "s3://${TemplateBucketName}/resolvers/${Stage}/${ResolversBuildHash}/comments/Mutations/Mutation.updateComment.js"

  DeleteCommentResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt GraphQlApi.ApiId
      TypeName: Mutation
      FieldName: deleteComment
      DataSourceName: !GetAtt MainTableDataSource.Name
      Kind: UNIT
      Runtime:
        Name: APPSYNC_JS
        RuntimeVersion: 1.0.0
      CodeS3Location: !Sub "s3://${TemplateBucketName}/resolvers/${Stage}/${ResolversBuildHash}/comments/Mutations/Mutation.deleteComment.js"

  VoteOnCommentResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt GraphQlApi.ApiId
      TypeName: Mutation
      FieldName: voteOnComment
      DataSourceName: !GetAtt MainTableDataSource.Name
      Kind: UNIT
      Runtime:
        Name: APPSYNC_JS
        RuntimeVersion: 1.0.0
      CodeS3Location: !Sub "s3://${TemplateBucketName}/resolvers/${Stage}/${ResolversBuildHash}/comments/Mutations/Mutation.voteOnComment.js"

  # Field resolver for nested replies
  CommentRepliesResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt GraphQlApi.ApiId
      TypeName: Comment
      FieldName: replies
      DataSourceName: !GetAtt MainTableDataSource.Name
      Kind: UNIT
      Runtime:
        Name: APPSYNC_JS
        RuntimeVersion: 1.0.0
      CodeS3Location: !Sub "s3://${TemplateBucketName}/resolvers/${Stage}/${ResolversBuildHash}/comments/Fields/Comment.replies.js"

  # Field resolver for Comment.authorPatreonSupporter
  CommentAuthorPatreonSupporterResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt GraphQlApi.ApiId
      TypeName: Comment
      FieldName: authorPatreonSupporter
      DataSourceName: !GetAtt MainTableDataSource.Name
      Kind: UNIT
      Runtime:
        Name: APPSYNC_JS
        RuntimeVersion: 1.0.0
      CodeS3Location: !Sub "s3://${TemplateBucketName}/resolvers/${Stage}/${ResolversBuildHash}/comments/Fields/Comment.authorPatreonSupporter.js"

  # Field resolver for Comment.authorOGSupporter
  CommentAuthorOGSupporterResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt GraphQlApi.ApiId
      TypeName: Comment
      FieldName: authorOGSupporter
      DataSourceName: !GetAtt MainTableDataSource.Name
      Kind: UNIT
      Runtime:
        Name: APPSYNC_JS
        RuntimeVersion: 1.0.0
      CodeS3Location: !Sub "s3://${TemplateBucketName}/resolvers/${Stage}/${ResolversBuildHash}/comments/Fields/Comment.authorOGSupporter.js"

  # List Stories Pipeline Functions
  QueryStoriesFunction:
    Type: AWS::AppSync::FunctionConfiguration
    Properties:
      ApiId: !GetAtt GraphQlApi.ApiId
      Name: !Sub "${AppName}QueryStoriesFunction"
      DataSourceName: !GetAtt MainTableDataSource.Name
      Runtime:
        Name: APPSYNC_JS
        RuntimeVersion: 1.0.0
      CodeS3Location: !Sub "s3://${TemplateBucketName}/resolvers/${Stage}/${ResolversBuildHash}/stories/Functions/Function.queryStories.js"

  # Create Chapter Pipeline Functions
  CreateChapterItemFunction:
    Type: AWS::AppSync::FunctionConfiguration
    Properties:
      ApiId: !GetAtt GraphQlApi.ApiId
      Name: !Sub "${AppName}CreateChapterItemFunction"
      DataSourceName: !GetAtt MainTableDataSource.Name
      Runtime:
        Name: APPSYNC_JS
        RuntimeVersion: 1.0.0
      CodeS3Location: !Sub "s3://${TemplateBucketName}/resolvers/${Stage}/${ResolversBuildHash}/chapters/Functions/Function.createChapterItem.js"

  UpdateStoryRootNodeFunction:
    Type: AWS::AppSync::FunctionConfiguration
    Properties:
      ApiId: !GetAtt GraphQlApi.ApiId
      Name: !Sub "${AppName}UpdateStoryRootNodeFunction"
      DataSourceName: !GetAtt MainTableDataSource.Name
      Runtime:
        Name: APPSYNC_JS
        RuntimeVersion: 1.0.0
      CodeS3Location: !Sub "s3://${TemplateBucketName}/resolvers/${Stage}/${ResolversBuildHash}/chapters/Functions/Function.updateStoryRootNode.js"

  # Story Branch Pipeline Functions
  FetchParentNodeFunction:
    Type: AWS::AppSync::FunctionConfiguration
    Properties:
      ApiId: !GetAtt GraphQlApi.ApiId
      Name: !Sub "${AppName}FetchParentNodeFunction"
      DataSourceName: !GetAtt MainTableDataSource.Name
      Runtime:
        Name: APPSYNC_JS
        RuntimeVersion: 1.0.0
      CodeS3Location: !Sub "s3://${TemplateBucketName}/resolvers/${Stage}/${ResolversBuildHash}/chapters/Functions/Function.fetchParentNode.js"

  CreateBranchItemFunction:
    Type: AWS::AppSync::FunctionConfiguration
    Properties:
      ApiId: !GetAtt GraphQlApi.ApiId
      Name: !Sub "${AppName}CreateBranchItemFunction"
      DataSourceName: !GetAtt MainTableDataSource.Name
      Runtime:
        Name: APPSYNC_JS
        RuntimeVersion: 1.0.0
      CodeS3Location: !Sub "s3://${TemplateBucketName}/resolvers/${Stage}/${ResolversBuildHash}/chapters/Functions/Function.createBranchItem.js"

  IncrementParentBranchCountFunction:
    Type: AWS::AppSync::FunctionConfiguration
    Properties:
      ApiId: !GetAtt GraphQlApi.ApiId
      Name: !Sub "${AppName}IncrementParentBranchCountFunction"
      DataSourceName: !GetAtt MainTableDataSource.Name
      Runtime:
        Name: APPSYNC_JS
        RuntimeVersion: 1.0.0
      CodeS3Location: !Sub "s3://${TemplateBucketName}/resolvers/${Stage}/${ResolversBuildHash}/chapters/Functions/Function.incrementParentBranchCount.js"

  CheckExistingVoteFunction:
    Type: AWS::AppSync::FunctionConfiguration
    Properties:
      ApiId: !GetAtt GraphQlApi.ApiId
      Name: !Sub "${AppName}CheckExistingVoteFunction"
      DataSourceName: !GetAtt MainTableDataSource.Name
      Runtime:
        Name: APPSYNC_JS
        RuntimeVersion: 1.0.0
      CodeS3Location: !Sub "s3://${TemplateBucketName}/resolvers/${Stage}/${ResolversBuildHash}/chapters/Functions/Function.checkExistingVote.js"

  RecordVoteFunction:
    Type: AWS::AppSync::FunctionConfiguration
    Properties:
      ApiId: !GetAtt GraphQlApi.ApiId
      Name: !Sub "${AppName}RecordVoteFunction"
      DataSourceName: !GetAtt MainTableDataSource.Name
      Runtime:
        Name: APPSYNC_JS
        RuntimeVersion: 1.0.0
      CodeS3Location: !Sub "s3://${TemplateBucketName}/resolvers/${Stage}/${ResolversBuildHash}/chapters/Functions/Function.recordVote.js"

  IncrementVoteCountFunction:
    Type: AWS::AppSync::FunctionConfiguration
    Properties:
      ApiId: !GetAtt GraphQlApi.ApiId
      Name: !Sub "${AppName}IncrementVoteCountFunction"
      DataSourceName: !GetAtt MainTableDataSource.Name
      Runtime:
        Name: APPSYNC_JS
        RuntimeVersion: 1.0.0
      CodeS3Location: !Sub "s3://${TemplateBucketName}/resolvers/${Stage}/${ResolversBuildHash}/chapters/Functions/Function.incrementVoteCount.js"

  # Story Branch Pipeline Resolvers
  CreateBranchResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt GraphQlApi.ApiId
      TypeName: Mutation
      FieldName: createBranch
      Kind: PIPELINE
      PipelineConfig:
        Functions:
          - !GetAtt FetchParentNodeFunction.FunctionId
          - !GetAtt CreateBranchItemFunction.FunctionId
          - !GetAtt IncrementParentBranchCountFunction.FunctionId
      Runtime:
        Name: APPSYNC_JS
        RuntimeVersion: 1.0.0
      Code: |
        export function request(ctx) {
          return {};
        }
        export function response(ctx) {
          return ctx.prev.result;
        }

  VoteOnChapterResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt GraphQlApi.ApiId
      TypeName: Mutation
      FieldName: voteOnChapter
      Kind: PIPELINE
      PipelineConfig:
        Functions:
          - !GetAtt CheckExistingVoteFunction.FunctionId
          - !GetAtt RecordVoteFunction.FunctionId
          - !GetAtt IncrementVoteCountFunction.FunctionId
      Runtime:
        Name: APPSYNC_JS
        RuntimeVersion: 1.0.0
      Code: |
        export function request(ctx) {
          return {};
        }
        export function response(ctx) {
          return ctx.prev.result;
        }

  # Site Settings Resolvers
  GetSiteSettingsResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt GraphQlApi.ApiId
      TypeName: Query
      FieldName: getSiteSettings
      DataSourceName: !GetAtt MainTableDataSource.Name
      Kind: UNIT
      Runtime:
        Name: APPSYNC_JS
        RuntimeVersion: 1.0.0
      CodeS3Location: !Sub "s3://${TemplateBucketName}/resolvers/${Stage}/${ResolversBuildHash}/settings/Queries/Query.getSiteSettings.js"

  UpdateSiteSettingsResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt GraphQlApi.ApiId
      TypeName: Mutation
      FieldName: updateSiteSettings
      DataSourceName: !GetAtt MainTableDataSource.Name
      Kind: UNIT
      Runtime:
        Name: APPSYNC_JS
        RuntimeVersion: 1.0.0
      CodeS3Location: !Sub "s3://${TemplateBucketName}/resolvers/${Stage}/${ResolversBuildHash}/settings/Mutations/Mutation.updateSiteSettings.js"

  # Explicit AppSync LogGroup so we can control retention
  # DeletionPolicy: Delete ensures LogGroup is removed when stack is deleted
  AppSyncApiLogGroup:
    Type: AWS::Logs::LogGroup
    DeletionPolicy: Delete
    UpdateReplacePolicy: Retain
    Properties:
      LogGroupName: !Sub "/aws/appsync/apis/${GraphQlApi.ApiId}"
      RetentionInDays: !Ref LogRetentionInDays

Outputs:
  AppSyncApiUrl:
    Value: !GetAtt GraphQlApi.GraphQLUrl
    Description: "GraphQL URL for the AppSync API"

  AppSyncRealtimeUrl:
    Value: !GetAtt GraphQlApi.RealtimeUrl
    Description: "Realtime URL for the AppSync API"

  AppSyncApiId:
    Value: !GetAtt GraphQlApi.ApiId
    Description: "API ID for the AppSync API"

  AppSyncLogGroupName:
    Description: Name of the AppSync CloudWatch LogGroup
    Value: !Sub "/aws/appsync/apis/${GraphQlApi.ApiId}"
