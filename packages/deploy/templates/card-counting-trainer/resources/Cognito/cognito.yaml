AWSTemplateFormatVersion: "2010-09-09"
Description: "Card Counting Trainer Cognito User Pool Resources"

Parameters:
  Stage:
    Type: String
    Description: Deployment stage (e.g., dev, prod)
  AppName:
    Type: String
    Description: Application short name used in exported resource names
  PostConfirmationLambdaArn:
    Type: String
    Description: ARN of the PostConfirmation Lambda function
    Default: ""

Conditions:
  HasPostConfirmationLambda: !Not [!Equals [!Ref PostConfirmationLambdaArn, ""]]

Resources:
  UserPool:
    Type: AWS::Cognito::UserPool
    Properties:
      UserPoolName: !Sub "nlmonorepo-cct-userpool-${Stage}"
      Schema:
        - Name: email
          AttributeDataType: String
          Mutable: true
          Required: true
      Policies:
        PasswordPolicy:
          MinimumLength: 8
      MfaConfiguration: "OFF"
      UserPoolTags:
        Stack: !Sub "nlmonorepo-cct-${Stage}"
      LambdaConfig:
        PostConfirmation: !If
          - HasPostConfirmationLambda
          - !Ref PostConfirmationLambdaArn
          - !Ref AWS::NoValue

  # Cognito User Pool Domain (required for OAuth)
  UserPoolDomain:
    Type: AWS::Cognito::UserPoolDomain
    Properties:
      Domain: !Sub "nlmonorepo-cct-${Stage}"
      UserPoolId: !Ref UserPool

  UserPoolClient:
    Type: AWS::Cognito::UserPoolClient
    Properties:
      ClientName: !Sub "nlmonorepo-cct-client-${Stage}"
      UserPoolId: !Ref UserPool
      GenerateSecret: false
      SupportedIdentityProviders:
        - COGNITO
      CallbackURLs:
        - "http://localhost:3001"
        - "https://cardcounting.example.com"  # TODO: Update with actual domain
      LogoutURLs:
        - "http://localhost:3001"
        - "https://cardcounting.example.com"  # TODO: Update with actual domain
      AllowedOAuthFlows:
        - code
      AllowedOAuthScopes:
        - email
        - openid
        - profile
        - aws.cognito.signin.user.admin
      AllowedOAuthFlowsUserPoolClient: true

Outputs:
  UserPoolId:
    Description: ID of the Cognito User Pool
    Value: !Ref UserPool

  UserPoolArn:
    Description: ARN of the Cognito User Pool
    Value: !GetAtt UserPool.Arn

  UserPoolClientId:
    Description: ID of the Cognito User Pool Client
    Value: !Ref UserPoolClient

  UserPoolProviderName:
    Description: Provider name of the Cognito User Pool
    Value: !GetAtt UserPool.ProviderName

  UserPoolDomain:
    Description: Domain prefix for the Cognito User Pool
    Value: !Ref UserPoolDomain
